{% extends "base.html" %}

{% block title %}Khipu - Matem√°ticas Andinas{% endblock %}
{% block game_title %}Khipu - Sistema de Nudos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game.css') }}">
<style>
    /* =========================================
       üé® PALETA DE COLORES Y TEXTURAS ANDINAS
       ========================================= */
    :root {
        --parchment-bg: #fdf5e6;
        --wood-border: #8B4513;
        --rope-dark: #3e2723;
        --rope-light: #795548;
        --gold-inca: #FFD700;
        --text-color: #3E2723;
        
        /* Textura de soga realista hecha con CSS */
        --rope-texture: repeating-linear-gradient(
            45deg,
            var(--rope-dark),
            var(--rope-dark) 4px,
            #5d4037 4px,
            #5d4037 8px
        );
    }

    /* =========================================
       1. LAYOUT GENERAL
       ========================================= */
    .game-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 85vh;
        padding: 40px;
        gap: 50px;
        max-width: 1400px;
        margin: 0 auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Fondo general */
    .game-background {
        background: linear-gradient(135deg, #fdfbf7 0%, #e6dace 100%);
        opacity: 0.8;
    }

    /* =========================================
       2. PANEL LATERAL (ESTILO PERGAMINO)
       ========================================= */
    .sidebar-panel {
        flex: 0 0 320px;
        background-color: var(--parchment-bg);
        border: 4px solid var(--wood-border);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 10px 10px 20px rgba(0,0,0,0.2), inset 0 0 40px rgba(139, 69, 19, 0.1);
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
    }

    /* Efecto de "clavos" en las esquinas del panel */
    .sidebar-panel::after {
        content: '';
        position: absolute;
        top: 10px; right: 10px;
        width: 10px; height: 10px;
        background: #5d4037;
        border-radius: 50%;
        box-shadow: 0 0 0 2px #3e2723, -275px 0 0 0 #5d4037, -275px 0 0 0 2px #3e2723; 
    }

    .question-title {
        color: var(--text-color);
        font-size: 1.8em;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 3px double var(--wood-border) !important;
    }

    .question-info {
        background: rgba(139, 69, 19, 0.08) !important;
        border: 1px dashed var(--wood-border);
    }

    /* =========================================
       3. √ÅREA DE JUEGO (CENTRO)
       ========================================= */
    .main-game-stage {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 25px;
        max-width: 900px;
    }

    /* Panel de Puntuaci√≥n (Estilo Tablilla) */
    .info-panel {
        background: #5D4037; /* Madera oscura */
        border: 3px solid #3E2723;
        border-radius: 8px;
        padding: 15px 40px;
        width: 100%;
        display: flex;
        justify-content: space-between;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        color: #fff;
    }

    .current-number, .target-number {
        font-family: 'Courier New', monospace;
        font-size: 1.4em;
        text-shadow: 1px 1px 2px #000;
    }

    .current-number span { color: #4CAF50; font-weight: 800; }
    .target-number span { color: var(--gold-inca); font-weight: 800; }

    /* =========================================
       4. EL KHIPU REALISTA
       ========================================= */
    .khipu-area {
        width: 100%;
        min-height: 500px;
        position: relative;
        padding-top: 40px; /* Espacio para cuerda madre */
    }

    /* CUERDA MADRE (Horizontal) - Textura Realista */
    .khipu-area::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 20px;
        background: var(--rope-texture);
        border-radius: 10px;
        box-shadow: 0 5px 10px rgba(0,0,0,0.5);
        z-index: 5;
        transform: rotate(-0.5deg); /* Ligera imperfecci√≥n natural */
    }

    .cord-container {
        display: flex;
        flex-direction: row;
        justify-content: center;
        gap: 12%; /* Espaciado proporcional */
        width: 100%;
    }

    /* Cuerda Individual */
    .cord {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 90px;
        cursor: pointer;
        position: relative;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .cord:hover {
        transform: translateY(8px);
    }

    /* El "Nudo de amarre" a la cuerda madre */
    .cord::before {
        content: '';
        width: 24px;
        height: 24px;
        background: var(--rope-dark);
        border-radius: 50%;
        position: absolute;
        top: -10px; /* Sobre la cuerda madre */
        z-index: 6;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    /* Etiquetas (Estilo etiqueta de madera colgante) */
    .cord-label {
        background: #8B4513;
        background-image: linear-gradient(to bottom, #8B4513, #5D4037);
        color: #fff;
        padding: 5px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        margin-top: 15px; /* Debajo de la cuerda madre */
        margin-bottom: 5px;
        text-align: center;
        box-shadow: 0 3px 5px rgba(0,0,0,0.3);
        border: 1px solid #3E2723;
        z-index: 4;
        font-weight: bold;
    }

    /* La Cuerda Colgante (Textura trenzada) */
    .cord-line {
        width: 10px;
        height: 350px;
        background: repeating-linear-gradient(
            0deg,
            var(--rope-light),
            var(--rope-light) 3px,
            #8d6e63 3px,
            #8d6e63 6px
        );
        border-radius: 0 0 5px 5px;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 15px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.3);
        margin-top: -5px; /* Conectar con la etiqueta */
        z-index: 3;
    }

    /* =========================================
       5. NUDOS 3D (Logic Hooks Preserved)
       ========================================= */
    /* Estos estilos se aplican a los DIVs creados por JS */
    .knot, .cord-line div { 
        width: 24px;
        height: 20px;
        border-radius: 40%;
        margin-bottom: 6px;
        box-shadow: inset -2px -2px 5px rgba(0,0,0,0.4), 2px 2px 4px rgba(0,0,0,0.3);
        flex-shrink: 0;
        border: 1px solid rgba(255,255,255,0.1);
        /* Animaci√≥n de entrada */
        animation: dropKnot 0.4s ease-out;
    }

    @keyframes dropKnot {
        0% { transform: scale(0) translateY(-20px); opacity: 0; }
        60% { transform: scale(1.1) translateY(0); opacity: 1; }
        100% { transform: scale(1); }
    }
    
    /* Colores Espec√≠ficos por posici√≥n (Sobreescribimos JS styles si es necesario) */
    #cord0 .knot, #cord0 div { background: radial-gradient(circle at 40% 40%, #D32F2F, #8B0000) !important; } /* Centenas - Rojo */
    #cord1 .knot, #cord1 div { background: radial-gradient(circle at 40% 40%, #CD853F, #A0522D) !important; } /* Decenas - Ocre */
    #cord2 .knot, #cord2 div { background: radial-gradient(circle at 40% 40%, #6B8E23, #556B2F) !important; } /* Unidades - Verde */

    /* Contador Dorado */
    .knot-count {
        margin-top: 10px;
        background: radial-gradient(circle at 30% 30%, #FFD700, #DAA520);
        color: #3E2723;
        width: 35px; height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2em;
        border: 2px solid #B8860B;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    /* =========================================
       6. BOTONES Y UI
       ========================================= */
    .controls {
        background: rgba(255,255,255,0.8);
        padding: 15px;
        border-radius: 50px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .btn {
        border-radius: 25px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 10px 20px;
        transition: transform 0.2s;
        box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    }
    .btn:active { transform: translateY(4px); box-shadow: none; }
    
    /* Responsive */
    @media (max-width: 900px) {
        .game-container { flex-direction: column; align-items: center; padding: 10px; }
        .sidebar-panel { width: 100%; flex: none; }
        .cord-container { gap: 20px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container khipu-container">
    <div class="game-background khipu-background" style="position: absolute; top:0; left:0; width:100%; height:100%; z-index:-1;"></div>
    
    <div class="sidebar-panel">
        <div class="question-header">
            <h2 class="question-title">Khipu Andino</h2>
        </div>
        
        <p class="question-desc" id="questionDesc" style="color: #3e2723; line-height: 1.6;">
            <strong>Misi√≥n:</strong> Como un <em>Khipucamayoc</em> (contador inca), debes registrar los tributos.
            <br><br>
            Toca las cuerdas colgantes para anudar el n√∫mero que se te pide.
        </p>

        <div class="question-info" style="border-radius: 8px; padding:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span><strong>Grado:</strong> {{ grade }}</span>
                <span><strong>Nivel:</strong> {{ level }}</span>
            </div>
            <div id="timeRemaining" style="display: none; color:#D32F2F; font-weight:bold; text-align:center;">
                ‚è≥ Tiempo: <span id="timeValue">--</span>s
            </div>
        </div>

        <div class="instructions-mini" style="font-size: 0.9em; background: rgba(0,0,0,0.05); padding:10px; border-radius:5px;">
            <strong style="color:#8B4513">Lectura:</strong>
            <ul style="margin: 5px 0 0 20px; padding:0;">
                <li>Izquierda: Centenas (100)</li>
                <li>Centro: Decenas (10)</li>
                <li>Derecha: Unidades (1)</li>
            </ul>
        </div>

        <button class="btn" onclick="showHelp()" style="width:100%; background:#8B4513; color:white; border:none; margin-top:auto;">
            ‚ùì Ayuda Visual
        </button>
    </div>

    <div class="main-game-stage">
        
        <div class="info-panel">
            <div class="current-number">
                ACUMULADO: <span id="currentNumber">0</span>
            </div>
            <div class="target-number">
                OBJETIVO: <span id="targetNumber">--</span>
            </div>
        </div>

        <div class="khipu-area">
            <div class="cord-container">
                
                <div class="cord" onclick="addKnot(0)" id="cord-wrapper-0">
                    <div class="cord-label">CENTENA<br>(100)</div>
                    <div class="cord-line" id="cord0"></div>
                    <div class="knot-count" id="count0">0</div>
                </div>

                <div class="cord" onclick="addKnot(1)" id="cord-wrapper-1">
                    <div class="cord-label">DECENA<br>(10)</div>
                    <div class="cord-line" id="cord1"></div>
                    <div class="knot-count" id="count1">0</div>
                </div>

                <div class="cord" onclick="addKnot(2)" id="cord-wrapper-2">
                    <div class="cord-label">UNIDAD<br>(1)</div>
                    <div class="cord-line" id="cord2"></div>
                    <div class="knot-count" id="count2">0</div>
                </div>

            </div>
        </div>

        <div class="controls" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
            <button class="btn btn-success" onclick="generateTarget()" style="background:#2E7D32; color:white; border:none;">üéØ Nuevo Reto</button>
            <button class="btn btn-warning" onclick="reset()" style="background:#FF8F00; color:white; border:none;">üîÑ Borrar</button>
            <button class="btn btn-danger" onclick="removeKnot()" style="background:#C62828; color:white; border:none;">‚ûñ Quitar</button>
            <button class="btn btn-info" onclick="showHint()" style="background:#0277BD; color:white; border:none;">üí° Pista</button>
        </div>

        <div class="score-panel" style="display: flex; gap: 20px; font-weight: bold; color: #5D4037; background:rgba(255,255,255,0.5); padding:5px 20px; border-radius:15px;">
            <div>üèÜ Puntos: <span id="score">0</span></div>
            <div>üî• Racha: <span id="streak">0</span></div>
        </div>
        
        <div id="achievement" class="achievement" style="display: none;"></div>
        
        <div class="progress-container" style="width: 100%; margin-top: 10px;">
            <div class="progress-bar" style="background:#ddd; height:10px; border-radius:5px;">
                <div class="progress-fill" style="width: 0%; background:#4CAF50; height:100%; border-radius:5px; transition:width 0.3s;"></div>
            </div>
        </div>

    </div>
</div>

<div class="modal" id="helpModal" style="display: none;">
    <div class="modal-content" style="border: 4px solid #8B4513; background:#fdf5e6;">
        <div class="modal-header" style="background:#8B4513; color:white;">
            <h3>Gu√≠a del Khipucamayoc</h3>
            <button class="modal-close" onclick="closeHelp()" style="color:white;">&times;</button>
        </div>
        <div class="modal-body" style="color:#3e2723;">
            <p>1. Mira el n√∫mero <strong>OBJETIVO</strong> arriba.</p>
            <p>2. Haz clic en las cuerdas para poner nudos.</p>
            <p>3. <strong>Sistema Posicional:</strong></p>
            <ul>
                <li>üî¥ Roja (Izquierda): Vale 100</li>
                <li>üü† Ocre (Centro): Vale 10</li>
                <li>üü¢ Verde (Derecha): Vale 1</li>
            </ul>
        </div>
    </div>
</div>

<script>
window.GAME_DATA = {
    game: 'khipu',
    grade: {{ grade | tojson }},
    level: {{ level | tojson }},
    levels: {{ levels | tojson | safe }}
};
</script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/progress-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/game-engine.js') }}"></script>
<script src="{{ url_for('static', filename='js/tutorials.js') }}"></script>
<script src="{{ url_for('static', filename='js/khipu-dynamic.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Iniciando Khipu con Dise√±o Mejorado...");

    // Funci√≥n de arranque seguro (MANTENIDA EXACTAMENTE IGUAL)
    function startGameSafe() {
        console.log("üéÆ Ejecutando initKhipuImprovedGame...");
        if (typeof initKhipuImprovedGame === 'function') {
            initKhipuImprovedGame();
            
            // FORZAR GENERACI√ìN DE OBJETIVO SI NO SE CRE√ì
            setTimeout(() => {
                const targetEl = document.getElementById('targetNumber');
                if (targetEl && (targetEl.innerText === '--' || targetEl.innerText === '')) {
                    console.log("‚ö†Ô∏è No hay objetivo, forzando generaci√≥n...");
                    if (typeof generateTarget === 'function') generateTarget();
                }
            }, 500);
            
            showGameHeader();
        } else {
            console.error("‚ùå Error: No se encuentra la funci√≥n initKhipuImprovedGame. Revisa khipu-dynamic.js");
        }
    }

    // Intentar iniciar v√≠a tutorial
    if (typeof showTutorial === 'function') {
        showTutorial('khipu', function() {
            console.log("üìö Tutorial completado.");
            startGameSafe();
        });
    } else {
        console.warn("‚ö†Ô∏è No se encontr√≥ sistema de tutorial, iniciando directo.");
        startGameSafe();
    }
});
</script>
{% endblock %}