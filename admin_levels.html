<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Niveles - Matem√°ticas Andinas</title>

    <!-- CHANGE HERE: Rutas de CSS y metadatos -->
    <meta name="description" content="Juego educativo de matem√°ticas con elementos de la cultura andina">
    <meta name="keywords" content="matem√°ticas, educaci√≥n, cultura andina, khipu, yupana, chacana">
    <meta name="author" content="Matem√°ticas Andinas">

    <link rel="stylesheet" href="static/css/base.css">


    <!-- Favicon -->
    <link rel="icon" type="image/png" href="static/images/logos/logouno.png">
</head>
<body>
    <!-- Header Navigation -->
    <header class="game-header" id="gameHeader" style="display: none;">
        <div class="header-content">
            <div class="header-left">
                <button class="btn-home" onclick="goHome()" aria-label="Volver al inicio">
                    <span class="icon-home">üè†</span>
                </button>
                <div class="level-info">
                    <span id="currentLevel">Nivel 1</span>
                    <span id="currentGrade">Grado 1</span>
                </div>
            </div>

            <div class="header-center">
                <h1 id="gameTitle">{% block game_title %}Matem√°ticas Andinas{% endblock %}</h1>
            </div>

            <div class="header-right">
                <button class="btn-pause" onclick="togglePause()" aria-label="Pausar juego">
                    <span class="icon-pause">‚è∏Ô∏è</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="admin-container">
    <header class="admin-header">
        <h1>Editor de Niveles</h1>
        <p>Configura los niveles para cada juego de Matem√°ticas Andinas</p>
        <!-- CHANGE HERE: A√±adir controles de autenticaci√≥n si es necesario -->
        <div class="admin-warning">
            ‚ö†Ô∏è <strong>Atenci√≥n:</strong> Los cambios aqu√≠ afectan a todos los usuarios
        </div>
    </header>

    <!-- Game Tabs -->
    <div class="game-tabs">
        <button class="tab-button active" data-game="khipu">Khipu</button>
        <button class="tab-button" data-game="yupana">Yupana</button>
        <button class="tab-button" data-game="chacana">Chacana</button>
    </div>

    <!-- Levels Container -->
    <div class="levels-container">
        <!-- Khipu Levels -->
        <div class="tab-content active" data-game="khipu">
            <div class="section-header">
                <h2>Niveles de Khipu</h2>
                <button class="btn btn-primary" onclick="addLevel('khipu')">A√±adir Nivel</button>
            </div>
            <div class="levels-grid" id="khipu-levels">
                <!-- Los niveles se cargar√°n din√°micamente -->
            </div>
        </div>

        <!-- Yupana Levels -->
        <div class="tab-content" data-game="yupana" style="display: none;">
            <div class="section-header">
                <h2>Niveles de Yupana</h2>
                <button class="btn btn-primary" onclick="addLevel('yupana')">A√±adir Nivel</button>
            </div>
            <div class="levels-grid" id="yupana-levels">
                <!-- Los niveles se cargar√°n din√°micamente -->
            </div>
        </div>

        <!-- Chacana Levels -->
        <div class="tab-content" data-game="chacana" style="display: none;">
            <div class="section-header">
                <h2>Niveles de Chacana</h2>
                <button class="btn btn-primary" onclick="addLevel('chacana')">A√±adir Nivel</button>
            </div>
            <div class="levels-grid" id="chacana-levels">
                <!-- Los niveles se cargar√°n din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="admin-actions">
        <button class="btn btn-success" onclick="saveAllLevels()">Guardar Cambios</button>
        <button class="btn btn-secondary" onclick="loadLevels()">Recargar</button>
        <button class="btn btn-tertiary" onclick="goHome()">Volver al Inicio</button>
    </div>

    <!-- Status Messages -->
    <div class="status-messages" id="statusMessages"></div>
</div>

<script>
let currentLevels = {}
;

document.addEventListener('DOMContentLoaded', function() {
    initLevelsEditor();
    loadLevels();
    
    // CHANGE HERE: Configuraci√≥n del editor de niveles
    console.log('‚öôÔ∏è Levels editor initialized');
});

function initLevelsEditor() {
    // Tab switching
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const game = this.dataset.game;
            
            // Update active tab
            tabButtons.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => {
                c.classList.remove('active');
                c.style.display = 'none';
            });
            
            this.classList.add('active');
            const targetContent = document.querySelector(`[data-game="${game}"].tab-content`);
            targetContent.classList.add('active');
            targetContent.style.display = 'block';
        });
    });
}

function loadLevels() {
    for (const game in currentLevels) {
        renderLevels(game, currentLevels[game]);
    }
}

function renderLevels(game, levels) {
    const container = document.getElementById(`${game}-levels`);
    container.innerHTML = '';
    
    levels.forEach((level, index) => {
        const levelCard = createLevelCard(game, level, index);
        container.appendChild(levelCard);
    });
}

function createLevelCard(game, level, index) {
    const card = document.createElement('div');
    card.className = 'level-card';
    card.innerHTML = `
        <div class="level-header">
            <h3>Grado ${level.grade} - Nivel ${level.level}</h3>
            <button class="btn btn-small btn-danger" onclick="removeLevel('${game}', ${index})">Eliminar</button>
        </div>
        <div class="level-fields">
            <label>Grado:</label>
            <input type="number" class="level-input" value="${level.grade}" 
                   onchange="updateLevel('${game}', ${index}, 'grade', this.value)">
            
            <label>Nivel:</label>
            <input type="number" class="level-input" value="${level.level}" 
                   onchange="updateLevel('${game}', ${index}, 'level', this.value)">
            
            <label>M√≠nimo:</label>
            <input type="number" class="level-input" value="${level.target_min}" 
                   onchange="updateLevel('${game}', ${index}, 'target_min', this.value)">
            
            <label>M√°ximo:</label>
            <input type="number" class="level-input" value="${level.target_max}" 
                   onchange="updateLevel('${game}', ${index}, 'target_max', this.value)">
            
            <label>Tiempo (segundos, 0 = sin l√≠mite):</label>
            <input type="number" class="level-input" value="${level.time}" 
                   onchange="updateLevel('${game}', ${index}, 'time', this.value)">
            
            <label>Descripci√≥n:</label>
            <input type="text" class="level-input" value="${level.desc}" 
                   onchange="updateLevel('${game}', ${index}, 'desc', this.value)">
            
            <label>Dificultad:</label>
            <select class="level-input" onchange="updateLevel('${game}', ${index}, 'difficulty', this.value)">
                <option value="facil" ${level.difficulty === 'facil' ? 'selected' : ''}>F√°cil</option>
                <option value="medio" ${level.difficulty === 'medio' ? 'selected' : ''}>Medio</option>
                <option value="dificil" ${level.difficulty === 'dificil' ? 'selected' : ''}>Dif√≠cil</option>
            </select>
        </div>
    `;
    return card;
}

function addLevel(game) {
    const newLevel = {
        grade: 1,
        level: currentLevels[game].length + 1,
        target_min: 1,
        target_max: 10,
        time: 0,
        desc: "Nuevo nivel",
        difficulty: "facil",
        concepts: ["nuevo concepto"]
    };
    
    currentLevels[game].push(newLevel);
    renderLevels(game, currentLevels[game]);
}

function removeLevel(game, index) {
    if (confirm('¬øEst√°s seguro de eliminar este nivel?')) {
        currentLevels[game].splice(index, 1);
        renderLevels(game, currentLevels[game]);
    }
}

function updateLevel(game, index, field, value) {
    if (field === 'grade' || field === 'level' || field === 'target_min' || field === 'target_max' || field === 'time') {
        currentLevels[game][index][field] = parseInt(value);
    } else {
        currentLevels[game][index][field] = value;
    }
}

function saveAllLevels() {
    fetch('/api/levels', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(currentLevels)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Niveles guardados correctamente', 'success');
        } else {
            showStatus('Error al guardar: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showStatus('Error de conexi√≥n: ' + error.message, 'error');
    });
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessages');
    statusDiv.innerHTML = `<div class="status-message ${type}">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 5000);
}
</script>
    </main>

    <!-- Pause Overlay -->
    <div class="pause-overlay" id="pauseOverlay" style="display: none;">
        <div class="pause-menu">
            <h2>Juego Pausado</h2>
            <div class="pause-buttons">
                <button class="btn btn-primary" onclick="resumeGame()" aria-label="Reanudar juego">
                    Reanudar
                </button>
                <button class="btn btn-secondary" onclick="restartLevel()" aria-label="Reiniciar nivel">
                    Reiniciar Nivel
                </button>
                <button class="btn btn-tertiary" onclick="goHome()" aria-label="Volver al inicio">
                    Volver al Inicio
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Cargando...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="static/js/main.js"></script>
    <script src="static/js/game-common.js"></script>
    {% block extra_js %}{% endblock %}

    <!-- CHANGE HERE: Configuraci√≥n de desarrollo -->
    <script>
        // Configuraci√≥n global de la aplicaci√≥n
        window.MATEMATICAS_ANDINAS = {
            version: '1.0.0',
            debug: true, // CHANGE HERE: false para producci√≥n
            apiUrl: '/api'
        };

        // SUGGEST: make a git commit and tag as v1.0.0
        // Ejemplo: git commit -m "feat: initial complete implementation of Matematicas Andinas educational game"
        console.log('üèîÔ∏è Matem√°ticas Andinas v' + window.MATEMATICAS_ANDINAS.version + ' cargado correctamente');
    </script>
        <script>
            // Shim global ligero para compatibilidad entre scripts.
            // Evita errores cuando algunos scripts esperan window.MathAndinas
            if (!window.MathAndinas) {
                window.MathAndinas = {
                    showPause: showPause || function() { const o = document.getElementById('pauseOverlay'); if (o) o.style.display='flex'; },
                    resumeGame: resumeGame || function() { const o = document.getElementById('pauseOverlay'); if (o) o.style.display='none'; },
                    goHome: goHome || function() { window.location.href = '/'; },
                    showNotification: function(message, type) {
                        // Simple fallback visual
                        const n = document.createElement('div');
                        n.className = 'toast-notification ' + (type || 'info');
                        n.textContent = message;
                        Object.assign(n.style, { position: 'fixed', right: '20px', bottom: '20px', background: '#333', color: '#fff', padding: '10px 14px', borderRadius: '8px', zIndex: 10000 });
                        document.body.appendChild(n);
                        setTimeout(() => n.remove(), 3500);
                    }
                };
            }
        </script>
</body>
</html>