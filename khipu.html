<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khipu - Matem√°ticas Andinas</title>

    <!-- CHANGE HERE: Rutas de CSS y metadatos -->
    <meta name="description" content="Juego educativo de matem√°ticas con elementos de la cultura andina">
    <meta name="keywords" content="matem√°ticas, educaci√≥n, cultura andina, khipu, yupana, chacana">
    <meta name="author" content="Matem√°ticas Andinas">

    <link rel="stylesheet" href="static/css/base.css">


    <!-- Favicon -->
    <link rel="icon" type="image/png" href="static/images/logos/logouno.png">
</head>
<body>
    <!-- Header Navigation -->
    <header class="game-header" id="gameHeader" style="display: none;">
        <div class="header-content">
            <div class="header-left">
                <button class="btn-home" onclick="goHome()" aria-label="Volver al inicio">
                    <span class="icon-home">üè†</span>
                </button>
                <div class="level-info">
                    <span id="currentLevel">Nivel 1</span>
                    <span id="currentGrade">Grado 1</span>
                </div>
            </div>

            <div class="header-center">
                <h1 id="gameTitle">Khipu - Sistema de Nudos</h1>
            </div>

            <div class="header-right">
                <button class="btn-pause" onclick="togglePause()" aria-label="Pausar juego">
                    <span class="icon-pause">‚è∏Ô∏è</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="game-container khipu-container">
    <div class="game-background khipu-background" style="position: absolute; top:0; left:0; width:100%; height:100%; z-index:-1;"></div>

    <div class="sidebar-panel">
        <div class="question-header">
            <h2 class="question-title">Khipu Andino</h2>
        </div>

        <p class="question-desc" id="questionDesc" style="color: #3e2723; line-height: 1.6;">
            <strong>Misi√≥n:</strong> Como un <em>Khipucamayoc</em> (contador inca), debes registrar los tributos.
            <br><br>
            Toca las cuerdas colgantes para anudar el n√∫mero que se te pide.
        </p>

        <div class="question-info" style="border-radius: 8px; padding:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span><strong>Grado:</strong> 1</span>
                <span><strong>Nivel:</strong> 1</span>
            </div>
            <div id="timeRemaining" style="display: none; color:#D32F2F; font-weight:bold; text-align:center;">
                ‚è≥ Tiempo: <span id="timeValue">--</span>s
            </div>
        </div>

        <div class="instructions-mini" style="font-size: 0.9em; background: rgba(0,0,0,0.05); padding:10px; border-radius:5px;">
            <strong style="color:#8B4513">Lectura:</strong>
            <ul style="margin: 5px 0 0 20px; padding:0;">
                <li>Izquierda: Centenas (100)</li>
                <li>Centro: Decenas (10)</li>
                <li>Derecha: Unidades (1)</li>
            </ul>
        </div>

        <button class="btn" onclick="showHelp()" style="width:100%; background:#8B4513; color:white; border:none; margin-top:auto;">
            ‚ùì Ayuda Visual
        </button>
    </div>

    <div class="main-game-stage">

        <div class="info-panel">
            <div class="current-number">
                ACUMULADO: <span id="currentNumber">0</span>
            </div>
            <div class="target-number">
                OBJETIVO: <span id="targetNumber">--</span>
            </div>
        </div>

        <div class="khipu-area">
            <div class="cord-container">

                <div class="cord" onclick="addKnot(0)" id="cord-wrapper-0">
                    <div class="cord-label">CENTENA<br>(100)</div>
                    <div class="cord-line" id="cord0"></div>
                    <div class="knot-count" id="count0">0</div>
                </div>

                <div class="cord" onclick="addKnot(1)" id="cord-wrapper-1">
                    <div class="cord-label">DECENA<br>(10)</div>
                    <div class="cord-line" id="cord1"></div>
                    <div class="knot-count" id="count1">0</div>
                </div>

                <div class="cord" onclick="addKnot(2)" id="cord-wrapper-2">
                    <div class="cord-label">UNIDAD<br>(1)</div>
                    <div class="cord-line" id="cord2"></div>
                    <div class="knot-count" id="count2">0</div>
                </div>

            </div>
        </div>

        <div class="controls" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
            <button class="btn btn-success" onclick="generateTarget()" style="background:#2E7D32; color:white; border:none;">üéØ Nuevo Reto</button>
            <button class="btn btn-warning" onclick="reset()" style="background:#FF8F00; color:white; border:none;">üîÑ Borrar</button>
            <button class="btn btn-danger" onclick="removeKnot()" style="background:#C62828; color:white; border:none;">‚ûñ Quitar</button>
            <button class="btn btn-info" onclick="showHint()" style="background:#0277BD; color:white; border:none;">üí° Pista</button>
        </div>

        <div class="score-panel" style="display: flex; gap: 20px; font-weight: bold; color: #5D4037; background:rgba(255,255,255,0.5); padding:5px 20px; border-radius:15px;">
            <div>üèÜ Puntos: <span id="score">0</span></div>
            <div>üî• Racha: <span id="streak">0</span></div>
        </div>

        <div id="achievement" class="achievement" style="display: none;"></div>

        <div class="progress-container" style="width: 100%; margin-top: 10px;">
            <div class="progress-bar" style="background:#ddd; height:10px; border-radius:5px;">
                <div class="progress-fill" style="width: 0%; background:#4CAF50; height:100%; border-radius:5px; transition:width 0.3s;"></div>
            </div>
        </div>

    </div>
</div>

<div class="modal" id="helpModal" style="display: none;">
    <div class="modal-content" style="border: 4px solid #8B4513; background:#fdf5e6;">
        <div class="modal-header" style="background:#8B4513; color:white;">
            <h3>Gu√≠a del Khipucamayoc</h3>
            <button class="modal-close" onclick="closeHelp()" style="color:white;">&times;</button>
        </div>
        <div class="modal-body" style="color:#3e2723;">
            <p>1. Mira el n√∫mero <strong>OBJETIVO</strong> arriba.</p>
            <p>2. Haz clic en las cuerdas para poner nudos.</p>
            <p>3. <strong>Sistema Posicional:</strong></p>
            <ul>
                <li>üî¥ Roja (Izquierda): Vale 100</li>
                <li>üü† Ocre (Centro): Vale 10</li>
                <li>üü¢ Verde (Derecha): Vale 1</li>
            </ul>
        </div>
    </div>
</div>

<script>
window.GAME_DATA = {
    game: 'khipu',
    grade: '1',
    level: '1',
    levels: {}
};
</script>
    </main>

    <!-- Pause Overlay -->
    <div class="pause-overlay" id="pauseOverlay" style="display: none;">
        <div class="pause-menu">
            <h2>Juego Pausado</h2>
            <div class="pause-buttons">
                <button class="btn btn-primary" onclick="resumeGame()" aria-label="Reanudar juego">
                    Reanudar
                </button>
                <button class="btn btn-secondary" onclick="restartLevel()" aria-label="Reiniciar nivel">
                    Reiniciar Nivel
                </button>
                <button class="btn btn-tertiary" onclick="goHome()" aria-label="Volver al inicio">
                    Volver al Inicio
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Cargando...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="static/js/main.js"></script>
    <script src="static/js/game-common.js"></script>
    <script src="static/js/progress-manager.js"></script>
<script src="static/js/game-engine.js"></script>
<script src="static/js/tutorials.js"></script>
<script src="static/js/khipu-dynamic.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Iniciando Khipu con Dise√±o Mejorado...");

    // Funci√≥n de arranque seguro (MANTENIDA EXACTAMENTE IGUAL)
    function startGameSafe() {
        console.log("üéÆ Ejecutando initKhipuImprovedGame...");
        if (typeof initKhipuImprovedGame === 'function') {
            initKhipuImprovedGame();

            // FORZAR GENERACI√ìN DE OBJETIVO SI NO SE CRE√ì
            setTimeout(() => {
                const targetEl = document.getElementById('targetNumber');
                if (targetEl && (targetEl.innerText === '--' || targetEl.innerText === '')) {
                    console.log("‚ö†Ô∏è No hay objetivo, forzando generaci√≥n...");
                    if (typeof generateTarget === 'function') generateTarget();
                }
            }, 500);

            showGameHeader();
        } else {
            console.error("‚ùå Error: No se encuentra la funci√≥n initKhipuImprovedGame. Revisa khipu-dynamic.js");
        }
    }

    // Intentar iniciar v√≠a tutorial
    if (typeof showTutorial === 'function') {
        showTutorial('khipu', function() {
            console.log("üìö Tutorial completado.");
            startGameSafe();
        });
    } else {
        console.warn("‚ö†Ô∏è No se encontr√≥ sistema de tutorial, iniciando directo.");
        startGameSafe();
    }
});
</script>

    <!-- CHANGE HERE: Configuraci√≥n de desarrollo -->
    <script>
        // Configuraci√≥n global de la aplicaci√≥n
        window.MATEMATICAS_ANDINAS = {
            version: '1.0.0',
            debug: true, // CHANGE HERE: false para producci√≥n
            apiUrl: '/api'
        };

        // SUGGEST: make a git commit and tag as v1.0.0
        // Ejemplo: git commit -m "feat: initial complete implementation of Matematicas Andinas educational game"
        console.log('üèîÔ∏è Matem√°ticas Andinas v' + window.MATEMATICAS_ANDINAS.version + ' cargado correctamente');
    </script>
        <script>
            // Shim global ligero para compatibilidad entre scripts.
            // Evita errores cuando algunos scripts esperan window.MathAndinas
            if (!window.MathAndinas) {
                window.MathAndinas = {
                    showPause: showPause || function() { const o = document.getElementById('pauseOverlay'); if (o) o.style.display='flex'; },
                    resumeGame: resumeGame || function() { const o = document.getElementById('pauseOverlay'); if (o) o.style.display='none'; },
                    goHome: goHome || function() { window.location.href = '/'; },
                    showNotification: function(message, type) {
                        // Simple fallback visual
                        const n = document.createElement('div');
                        n.className = 'toast-notification ' + (type || 'info');
                        n.textContent = message;
                        Object.assign(n.style, { position: 'fixed', right: '20px', bottom: '20px', background: '#333', color: '#fff', padding: '10px 14px', borderRadius: '8px', zIndex: 10000 });
                        document.body.appendChild(n);
                        setTimeout(() => n.remove(), 3500);
                    }
                };
            }
        </script>
</body>
</html>